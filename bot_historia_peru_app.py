# -*- coding: utf-8 -*-
"""Untitled7.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1MUYwrR_qouFOTbrAtnv-P5jmsfXqAeqZ
"""

# bot_historia_peru_app.py
# -*- coding: utf-8 -*-
"""
Bot de Historia del PerÃº â€” Streamlit Cloud Edition
- TF-IDF + similitud coseno
- 30 Q&A con fuentes confiables (embebido)
- Carga opcional de dataset JSON
- Control de umbral, ejemplos rÃ¡pidos, y descarga del dataset
"""

import json
import unicodedata
from typing import List, Dict, Tuple, Optional

import streamlit as st
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity


# =============================
# Dataset ejemplo (30 Q&A)
# =============================
DATASET_30: List[Dict[str, object]] = [
    {"pregunta": "primer presidente del peru",
     "respuesta": "El primer presidente del PerÃº fue JosÃ© de la Riva-AgÃ¼ero en 1823.",
     "fuentes": [{"titulo": "JosÃ© de la Riva-AgÃ¼ero", "url": "https://es.wikipedia.org/wiki/Jos%C3%A9_de_la_Riva-Ag%C3%BCero_y_S%C3%A1nchez_Boquete"}]},
    {"pregunta": "independencia del peru",
     "respuesta": "La independencia del PerÃº fue proclamada el 28 de julio de 1821 por JosÃ© de San MartÃ­n.",
     "fuentes": [{"titulo": "Independencia del PerÃº", "url": "https://es.wikipedia.org/wiki/Independencia_del_Per%C3%BA"},
                 {"titulo": "BNP: Independencia del PerÃº", "url": "https://www.bnp.gob.pe/independencia-del-peru/"}]},
    {"pregunta": "batalla de ayacucho",
     "respuesta": "La Batalla de Ayacucho se librÃ³ el 9 de diciembre de 1824 y sellÃ³ la independencia sudamericana.",
     "fuentes": [{"titulo": "Batalla de Ayacucho", "url": "https://es.wikipedia.org/wiki/Batalla_de_Ayacucho"}]},
    {"pregunta": "culturas preincas",
     "respuesta": "Algunas culturas preincas fueron ChavÃ­n, Paracas, Nazca, Moche, Recuay y Wari.",
     "fuentes": [{"titulo": "Cultura ChavÃ­n", "url": "https://es.wikipedia.org/wiki/Cultura_Chav%C3%ADn"},
                 {"titulo": "Cultura Moche", "url": "https://es.wikipedia.org/wiki/Cultura_Moche"},
                 {"titulo": "Cultura Nazca", "url": "https://es.wikipedia.org/wiki/Cultura_Nazca"},
                 {"titulo": "Cultura Paracas", "url": "https://es.wikipedia.org/wiki/Cultura_Paracas"},
                 {"titulo": "Cultura Wari", "url": "https://es.wikipedia.org/wiki/Cultura_Wari"}]},
    {"pregunta": "civilizacion caral",
     "respuesta": "Caral es una de las civilizaciones mÃ¡s antiguas de AmÃ©rica, desarrollada entre 3000 y 1800 a.C. en el valle de Supe.",
     "fuentes": [{"titulo": "Caral-Supe", "url": "https://es.wikipedia.org/wiki/Caral-Supe"},
                 {"titulo": "Zona ArqueolÃ³gica Caral (oficial)", "url": "https://www.zonacaral.gob.pe/"}]},
    {"pregunta": "quien proclamo la independencia del peru",
     "respuesta": "JosÃ© de San MartÃ­n proclamÃ³ la independencia del PerÃº en Lima el 28 de julio de 1821.",
     "fuentes": [{"titulo": "JosÃ© de San MartÃ­n", "url": "https://es.wikipedia.org/wiki/Jos%C3%A9_de_San_Mart%C3%ADn"}]},
    {"pregunta": "quien fue simon bolivar",
     "respuesta": "SimÃ³n BolÃ­var fue un libertador que culminÃ³ la independencia del PerÃº tras las batallas de JunÃ­n y Ayacucho.",
     "fuentes": [{"titulo": "SimÃ³n BolÃ­var", "url": "https://es.wikipedia.org/wiki/Sim%C3%B3n_Bol%C3%ADvar"}]},
    {"pregunta": "batalla de junin",
     "respuesta": "La Batalla de JunÃ­n se librÃ³ el 6 de agosto de 1824 y fue una victoria patriota antes de Ayacucho.",
     "fuentes": [{"titulo": "Batalla de JunÃ­n", "url": "https://es.wikipedia.org/wiki/Batalla_de_Jun%C3%ADn"}]},
    {"pregunta": "guerra del pacifico",
     "respuesta": "La Guerra del PacÃ­fico se desarrollÃ³ entre 1879 y 1884 entre PerÃº, Bolivia y Chile.",
     "fuentes": [{"titulo": "Guerra del PacÃ­fico", "url": "https://es.wikipedia.org/wiki/Guerra_del_Pac%C3%ADfico"}]},
    {"pregunta": "fundacion de lima",
     "respuesta": "Lima fue fundada el 18 de enero de 1535 por Francisco Pizarro con el nombre de Ciudad de los Reyes.",
     "fuentes": [{"titulo": "Lima (fundaciÃ³n)", "url": "https://es.wikipedia.org/wiki/Lima#Historia"}]},
    {"pregunta": "quien fue pachacutec",
     "respuesta": "PachacÃºtec fue el noveno gobernante inca que expandiÃ³ el Tahuantinsuyo y reformÃ³ el Cusco.",
     "fuentes": [{"titulo": "PachacÃºtec", "url": "https://es.wikipedia.org/wiki/Pachac%C3%BAtec"}]},
    {"pregunta": "que fue el tahuantinsuyo",
     "respuesta": "El Tahuantinsuyo fue el imperio inca dividido en cuatro suyos: Chinchaysuyo, Collasuyo, Antisuyo y Cuntisuyo.",
     "fuentes": [{"titulo": "Imperio inca", "url": "https://es.wikipedia.org/wiki/Imperio_inca"}]},
    {"pregunta": "rebelion de tupac amaru ii",
     "respuesta": "La rebeliÃ³n de TÃºpac Amaru II se iniciÃ³ en 1780 como levantamiento indÃ­gena contra los abusos coloniales.",
     "fuentes": [{"titulo": "TÃºpac Amaru II", "url": "https://es.wikipedia.org/wiki/T%C3%BApac_Amaru_II"}]},
    {"pregunta": "quien fue jose de la mar",
     "respuesta": "JosÃ© de La Mar fue presidente del PerÃº entre 1827 y 1829 y participÃ³ en la independencia.",
     "fuentes": [{"titulo": "JosÃ© de La Mar", "url": "https://es.wikipedia.org/wiki/Jos%C3%A9_de_La_Mar"}]},
    {"pregunta": "reformas del virrey toledo",
     "respuesta": "Francisco de Toledo reorganizÃ³ la administraciÃ³n virreinal, reducciones y la mita minera.",
     "fuentes": [{"titulo": "Francisco de Toledo (virrey)", "url": "https://es.wikipedia.org/wiki/Francisco_de_Toledo_(virrey)"}]},
    {"pregunta": "batalla de arica",
     "respuesta": "La Batalla de Arica se librÃ³ el 7 de junio de 1880; destaca el sacrificio del coronel Francisco Bolognesi.",
     "fuentes": [{"titulo": "Batalla de Arica", "url": "https://es.wikipedia.org/wiki/Batalla_de_Arica"}]},
    {"pregunta": "quien fue miguel grau",
     "respuesta": "Miguel Grau fue el 'Caballero de los Mares', hÃ©roe naval peruano caÃ­do en Angamos (1879).",
     "fuentes": [{"titulo": "Miguel Grau", "url": "https://es.wikipedia.org/wiki/Miguel_Grau"}]},
    {"pregunta": "quien fue ramon castilla",
     "respuesta": "RamÃ³n Castilla fue presidente que aboliÃ³ la esclavitud y modernizÃ³ el Estado en el siglo XIX.",
     "fuentes": [{"titulo": "RamÃ³n Castilla", "url": "https://es.wikipedia.org/wiki/Ram%C3%B3n_Castilla"}]},
    {"pregunta": "constitucion de 1823",
     "respuesta": "La ConstituciÃ³n de 1823 fue la primera del PerÃº y estableciÃ³ la forma republicana de gobierno.",
     "fuentes": [{"titulo": "ConstituciÃ³n de 1823 (PerÃº)", "url": "https://es.wikipedia.org/wiki/Constituci%C3%B3n_Peruana_de_1823"}]},
    {"pregunta": "constitucion de 1993",
     "respuesta": "La ConstituciÃ³n de 1993 fue promulgada durante el gobierno de Alberto Fujimori y estÃ¡ vigente.",
     "fuentes": [{"titulo": "ConstituciÃ³n PolÃ­tica del PerÃº de 1993", "url": "https://es.wikipedia.org/wiki/Constituci%C3%B3n_Pol%C3%ADtica_del_Per%C3%BA_de_1993"}]},
    {"pregunta": "quien fue jose olaya",
     "respuesta": "JosÃ© Olaya fue un mÃ¡rtir de la independencia, mensajero clandestino, ejecutado en 1823.",
     "fuentes": [{"titulo": "JosÃ© Olaya", "url": "https://es.wikipedia.org/wiki/Jos%C3%A9_Olaya"}]},
    {"pregunta": "quien fue maria parrado de bellido",
     "respuesta": "MarÃ­a Parado de Bellido fue heroÃ­na de la independencia, fusilada por los realistas en 1822.",
     "fuentes": [{"titulo": "MarÃ­a Parado de Bellido", "url": "https://es.wikipedia.org/wiki/Mar%C3%ADa_Parado_de_Bellido"}]},
    {"pregunta": "quien fue francisco bolognesi",
     "respuesta": "Francisco Bolognesi defendiÃ³ el Morro de Arica en 1880 y es sÃ­mbolo del deber y honor militar.",
     "fuentes": [{"titulo": "Francisco Bolognesi", "url": "https://es.wikipedia.org/wiki/Francisco_Bolognesi"}]},
    {"pregunta": "quien fue ricardo palma",
     "respuesta": "Ricardo Palma fue escritor peruano, autor de las 'Tradiciones Peruanas'.",
     "fuentes": [{"titulo": "Ricardo Palma", "url": "https://es.wikipedia.org/wiki/Ricardo_Palma"}]},
    {"pregunta": "imperio wari",
     "respuesta": "El Imperio Wari se desarrollÃ³ entre los siglos VII y XIII en la regiÃ³n de Ayacucho.",
     "fuentes": [{"titulo": "Cultura Wari", "url": "https://es.wikipedia.org/wiki/Cultura_Wari"}]},
    {"pregunta": "quien fue jose carlos mariategui",
     "respuesta": "JosÃ© Carlos MariÃ¡tegui fue un pensador marxista peruano, autor de 'Siete ensayos...'.",
     "fuentes": [{"titulo": "JosÃ© Carlos MariÃ¡tegui", "url": "https://es.wikipedia.org/wiki/Jos%C3%A9_Carlos_Mari%C3%A1tegui"}]},
    {"pregunta": "batalla de tarapaca",
     "respuesta": "La Batalla de TarapacÃ¡ se librÃ³ el 27 de noviembre de 1879; fue una victoria peruana.",
     "fuentes": [{"titulo": "Batalla de TarapacÃ¡", "url": "https://es.wikipedia.org/wiki/Batalla_de_Tarapac%C3%A1_(1879)"}]},
    {"pregunta": "quien fue juan santos atahualpa",
     "respuesta": "Juan Santos Atahualpa liderÃ³ una rebeliÃ³n en la selva central en el siglo XVIII.",
     "fuentes": [{"titulo": "Juan Santos Atahualpa", "url": "https://es.wikipedia.org/wiki/Juan_Santos_Atahualpa"}]},
    {"pregunta": "quien fue manuel pardo",
     "respuesta": "Manuel Pardo fue el primer presidente civil del PerÃº (1872â€“1876) y fundador del Partido Civil.",
     "fuentes": [{"titulo": "Manuel Pardo", "url": "https://es.wikipedia.org/wiki/Manuel_Pardo_y_Lavalle"}]},
    {"pregunta": "batalla de san juan y miraflores",
     "respuesta": "Las batallas de San Juan y Miraflores se libraron en enero de 1881 durante la defensa de Lima.",
     "fuentes": [{"titulo": "CampaÃ±a de Lima", "url": "https://es.wikipedia.org/wiki/Campa%C3%B1a_de_Lima"}]}
]


# =============================
# Utilidades
# =============================
def normalize_text(text: str) -> str:
    text = text.strip().lower()
    text = ''.join(c for c in unicodedata.normalize('NFD', text)
                   if unicodedata.category(c) != 'Mn')
    return ' '.join(text.split())


# =============================
# Modelo / Bot
# =============================
@st.cache_resource(show_spinner=False)
def build_bot(data: List[Dict[str, object]], ngram=(1, 2)):
    questions = [normalize_text(d["pregunta"]) for d in data]
    answers = [d["respuesta"] for d in data]
    sources = [d.get("fuentes", []) for d in data]
    vec = TfidfVectorizer(ngram_range=ngram)
    X = vec.fit_transform(questions)
    return vec, X, questions, answers, sources

def predict(vec: TfidfVectorizer, X, questions, answers, sources,
            user_text: str, threshold: float) -> Tuple[str, float, List[Dict[str, str]]]:
    user_norm = normalize_text(user_text)
    sims = cosine_similarity(vec.transform([user_norm]), X)[0]
    idx = sims.argmax()
    score = float(sims[idx])
    if score < threshold:
        return "Lo siento, solo puedo responder preguntas de Historia del PerÃº.", score, []
    return answers[idx], score, sources[idx]


# =============================
# UI â€” Streamlit App
# =============================
def main():
    st.set_page_config(page_title="Bot Historia del PerÃº", page_icon="ğŸ‡µğŸ‡ª", layout="centered")

    # ---- Encabezado / Estilo ----
    st.markdown(
        """
        <style>
        .stTextInput > div > div > input { border-radius: 12px; }
        .block-container { padding-top: 2rem; }
        </style>
        """,
        unsafe_allow_html=True,
    )
    st.title("ğŸ‡µğŸ‡ª Bot de Historia del PerÃº")
    st.caption("NLP clÃ¡sico: TF-IDF + similitud coseno Â· Fuentes confiables incluidas")

    # ---- Sidebar ----
    with st.sidebar:
        st.subheader("âš™ï¸ ConfiguraciÃ³n")
        threshold = st.slider("Umbral de confianza (coseno)", 0.0, 1.0, 0.25, 0.01)
        st.write("Carga un dataset JSON opcional (formato: lista de objetos con "
                 "`pregunta`, `respuesta`, `fuentes[]`).")
        uploaded = st.file_uploader("Subir dataset (.json)", type=["json"])

        # Dataset activo (embebido o subido)
        if uploaded:
            try:
                data_ext = json.load(uploaded)
                assert isinstance(data_ext, list) and all("pregunta" in d and "respuesta" in d for d in data_ext)
                st.success(f"Dataset cargado: {len(data_ext)} entradas.")
                data = data_ext
            except Exception as e:
                st.error(f"JSON invÃ¡lido: {e}")
                data = DATASET_30
        else:
            data = DATASET_30

        # Descargar dataset de ejemplo
        st.download_button(
            "â¬‡ï¸ Descargar dataset de ejemplo (JSON)",
            data=json.dumps(DATASET_30, ensure_ascii=False, indent=2),
            file_name="dataset_historia_30_refs.json",
            mime="application/json",
            use_container_width=True
        )

        st.markdown("---")
        st.caption("Tip: Incrementa el umbral si quieres respuestas mÃ¡s seguras.")

    # ---- Construir modelo (cacheado) ----
    vec, X, questions, answers, sources = build_bot(data)

    # ---- Entrada principal ----
    col1, col2 = st.columns([3, 1])
    with col1:
        user_q = st.text_input("âœï¸ Escribe tu pregunta", placeholder="Ej. Â¿CuÃ¡ndo fue la Batalla de Ayacucho?")
    with col2:
        st.write("")  # spacing
        if st.button("Limpiar"):
            user_q = ""
            st.experimental_rerun()

    # ---- Preguntas de ejemplo ----
    st.markdown("**Ejemplos rÃ¡pidos:**")
    ex_cols = st.columns(3)
    examples = [
        "Â¿QuiÃ©n fue Miguel Grau?",
        "Â¿QuÃ© culturas preincas existieron?",
        "Â¿CuÃ¡ndo fue la Batalla de JunÃ­n?",
        "Â¿QuiÃ©n proclamÃ³ la independencia del PerÃº?",
        "Â¿QuÃ© es el Tahuantinsuyo?",
        "Â¿QuiÃ©n fue JosÃ© Carlos MariÃ¡tegui?"
    ]
    for i, e in enumerate(examples):
        if ex_cols[i % 3].button(e):
            user_q = e

    # ---- Respuesta ----
    if user_q:
        ans, sc, refs = predict(vec, X, questions, answers, sources, user_q, threshold)
        st.markdown("### ğŸ§  Respuesta")
        st.write(ans)
        st.caption(f"Confianza (similitud coseno): **{sc:.3f}**")

        if refs:
            st.markdown("#### ğŸ”— Fuentes sugeridas")
            for r in refs:
                st.markdown(f"- [{r.get('titulo','Fuente')}]({r.get('url','#')})")

    st.markdown("---")
    st.caption("Desarrollado con â¤ï¸ en Python + Streamlit Â· Autor: Yeltsin")


if __name__ == "__main__":
    main()